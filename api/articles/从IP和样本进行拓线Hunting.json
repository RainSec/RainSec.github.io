{"title":"从IP和样本进行拓线Hunting","uid":"770417add373829189d7a6ca63ee3b8d","slug":"从IP和样本进行拓线Hunting","date":"2023-05-25T10:38:45.000Z","updated":"2023-05-26T06:43:51.142Z","comments":true,"path":"api/articles/从IP和样本进行拓线Hunting.json","keywords":null,"cover":"https://cdn.staticaly.com/gh/L2ksy0d/image-host@master/20220211/image.2ytx72zryfw0.png","content":"<h1 id=\"从IP和样本进行拓线Hunting\"><a href=\"#从IP和样本进行拓线Hunting\" class=\"headerlink\" title=\"从IP和样本进行拓线Hunting\"></a>从IP和样本进行拓线Hunting</h1><h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>在情报生产中当你拿到一批样本，应该思考如何通过样本里的C2或者特征去拓线找到更多的恶意样本或者C2链接，本文将给出从一个样本出发进行拓线分析的例子，大佬轻喷。</p>\n<h2 id=\"QuasarRAT\"><a href=\"#QuasarRAT\" class=\"headerlink\" title=\"QuasarRAT\"></a>QuasarRAT</h2><h3 id=\"样本获取\"><a href=\"#样本获取\" class=\"headerlink\" title=\"样本获取\"></a>样本获取</h3><p>样本来源推荐一个网站：<a href=\"https://bazaar.abuse.ch/browse/\">MalwareBazaar</a></p>\n<p>其中收录了大量的样本，而且存在一些标识Tag帮助你快速的找到自己想要的样本，当然也是有对应的搜索语句的，学习一下即可。这里用<code>signature:QuasarRAT</code>进行搜索</p>\n<p><img src=\"https://cdn.staticaly.com/gh/L2ksy0d/image-host@master/20220211/image-20230519174917098.5yewl8fhsxw0.png\"></p>\n<p>这些都是被标记为<code>QuasarRAT</code>的样本，挑一些出来看看：</p>\n<p><img src=\"https://cdn.staticaly.com/gh/L2ksy0d/image-host@master/20220211/image-20230519174853964.6qifc2wzszw0.png\"></p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">SHA256 hash:\t 0183491852a035f91d926bc25b7f09e7f145c59429cfef10e3f9963caa95c068\nSHA1 hash:\t 89cb5af4f1953fb7b26c592d95461e0a2a9a546d\nMD5 hash:\t 5e48a824853c3c6b9fe64223fe12d7cb<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>样本准备好了，接下来就是进行一些行为分析，由于笔者不是专业的二进制样本分析师，所以我们借助沙箱和VirusTotal来进行分析。</p>\n<h3 id=\"样本分析\"><a href=\"#样本分析\" class=\"headerlink\" title=\"样本分析\"></a>样本分析</h3><p>把样本扔到各家的沙箱里，并且去<a href=\"https://www.virustotal.com/gui/file/78eb982abdfb385ac2e0c9a640856077379355f16e29788456a6551c166b00fe\">VirusTotal</a>查询一下当前样本的信息和关联情况</p>\n<h4 id=\"微步云沙箱\"><a href=\"#微步云沙箱\" class=\"headerlink\" title=\"微步云沙箱\"></a>微步云沙箱</h4><p>可以看到命中了一些沙箱的规则，但是没有检测到有释放的文件或者连接的远控server</p>\n<p><img src=\"https://cdn.staticaly.com/gh/L2ksy0d/image-host@master/20220211/image-20230519175013015.49kkn97ilne0.png\"></p>\n<p><img src=\"https://cdn.staticaly.com/gh/L2ksy0d/image-host@master/20220211/image-20230519175030479.3jt8mehy53o0.png\"></p>\n<h4 id=\"VirusTotal\"><a href=\"#VirusTotal\" class=\"headerlink\" title=\"VirusTotal\"></a>VirusTotal</h4><p>主力还是我们的vt，我们重点关注<code>RELATION</code>这个页面，其中包含了一些关联的样本和IP信息</p>\n<p><img src=\"https://cdn.staticaly.com/gh/L2ksy0d/image-host@master/20220211/image-20230519175108841.2jdzsp29ne00.png\"></p>\n<p><img src=\"https://cdn.staticaly.com/gh/L2ksy0d/image-host@master/20220211/image-20230519175122781.4froy1hyqly0.png\"></p>\n<p>对于多引擎无检出的优先级并不高，因为有些样本会通过连接白名单来判断当前的网络情况，所以我们优先判断<code>59.26.93.6</code>和<code>13.107.4.50</code></p>\n<h5 id=\"59-26-93-6\"><a href=\"#59-26-93-6\" class=\"headerlink\" title=\"59.26.93.6\"></a>59.26.93.6</h5><p><img src=\"https://cdn.staticaly.com/gh/L2ksy0d/image-host@master/20220211/image-20230519175244098.149zws6y2j6o.png\"></p>\n<p>关联样本有很多，但是名称很相近，跟进查看其他样本信息</p>\n<p><img src=\"https://cdn.staticaly.com/gh/L2ksy0d/image-host@master/20220211/image-20230519175319487.69gb0kgthfw0.png\"></p>\n<p><img src=\"https://cdn.staticaly.com/gh/L2ksy0d/image-host@master/20220211/image-20230519175343650.4wat4y6s6lq0.png\"></p>\n<p>几乎都是已经明确是<code>QuasarRAT</code>的样本，这样一来，我们从一个QuasarRAT样本找到了这个关联IP，而这个IP关联了多个已经被判定为QuasarRAT的样本,那么笔者就认为这个IP就是QuasarRAT的远控IP，后续进行分析。</p>\n<h5 id=\"13-107-4-50\"><a href=\"#13-107-4-50\" class=\"headerlink\" title=\"13.107.4.50\"></a>13.107.4.50</h5><p><img src=\"https://cdn.staticaly.com/gh/L2ksy0d/image-host@master/20220211/image-20230519175441425.4bnzw0mn9fw0.png\"></p>\n<p>可以看到这个IP关联的样本很多，笔者挑了几个看了一下涉及到的病毒种类也比较多，无法判定是单纯的QuasarRAT Server，所以这里就不做后续分析，有兴趣的师傅可以自己分析一下<a href=\"https://www.virustotal.com/gui/ip-address/13.107.4.50/relations\">VirusTotal - IP address - 13.107.4.50</a></p>\n<p><img src=\"https://cdn.staticaly.com/gh/L2ksy0d/image-host@master/20220211/image-20230519175531766.5p9jjykj7ko0.png\"></p>\n<p><img src=\"https://cdn.staticaly.com/gh/L2ksy0d/image-host@master/20220211/image-20230519175538739.nw01k7emgmo.png\"></p>\n<p><img src=\"https://cdn.staticaly.com/gh/L2ksy0d/image-host@master/20220211/image-20230519175548936.pil54gy6cog.png\"></p>\n<h3 id=\"IP分析\"><a href=\"#IP分析\" class=\"headerlink\" title=\"IP分析\"></a>IP分析</h3><p>我们拿到了<code>59.26.93.6</code>这个IP，接下来去空间测绘引擎查询一下IP的信息，本文以Shadon和Fofa为例</p>\n<p>语句：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">Shadon:  ip:\"59.26.93.6\"\nFofa  :  ip=\"59.26.93.6\"<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>结果中首先观察到这里：</p>\n<p><img src=\"https://cdn.staticaly.com/gh/L2ksy0d/image-host@master/20220211/image-20230519175939892.74hyyal44ts0.png\"></p>\n<p>很多端口的banner都是这串字符，这是<code>msrpc</code>的banner特征，所以这个就被我们pass</p>\n<p>然后我们查看https的证书，发现存在证书特征关键字<code>Quasar Server CA</code></p>\n<p><img src=\"https://cdn.staticaly.com/gh/L2ksy0d/image-host@master/20220211/image-20230519190538266.3f4kjl4xmv20.png\"></p>\n<p>Shadon也显示了该IP对应的证书信息</p>\n<p><img src=\"https://cdn.staticaly.com/gh/L2ksy0d/image-host@master/20220211/image-20230519190618479.8ak51tre9po.png\"></p>\n<p>到这里，我们找到了一个相关的特征，即证书的Subject或者Issuer是<code>Quasar Server CA</code>，接下来使用Shadon进行拓线</p>\n<h3 id=\"特征拓线\"><a href=\"#特征拓线\" class=\"headerlink\" title=\"特征拓线\"></a>特征拓线</h3><p>我们通过特征在Shadon搜索更多证书与<code>Quasar Server CA</code>相关的服务器</p>\n<p><code>ssl.cert.subject.cn:\"Quasar Server CA\"</code></p>\n<p><img src=\"https://cdn.staticaly.com/gh/L2ksy0d/image-host@master/20220211/image-20230519190842820.4r8nfnik1120.png\"></p>\n<p>直接相关的结果有19个，主要分布在毛里求斯、香港和德国。对应的端口也多为443端口，少量的1337和8009端口</p>\n<p>然后通过Shadon的聚合模式查看其他的特征信息，首先是JARM</p>\n<p><img src=\"https://cdn.staticaly.com/gh/L2ksy0d/image-host@master/20220211/image-20230523191218892.8r7713ww0q4.png\"></p>\n<p>获得<code>QuasarRAT</code>Server出现的JARM值，然后我们通过单独搜索JARM去尝试Hunting</p>\n<p><code>ssl.jarm:\"2ad2ad0002ad2ad0002ad2ad2ad2adf9fdf4eeac344e8b5003264da73585be\"</code></p>\n<p><img src=\"https://cdn.staticaly.com/gh/L2ksy0d/image-host@master/20220211/image-20230523191436005.4pygyv9c8n80.png\"></p>\n<p>看到12w个结果，基本可以确定不怎么靠谱，误报风险极极极极极极极极极极极极极极大</p>\n<p>其他的JARM看了结果也很多，所以这里就不考虑JARM，其他的指纹查看结果价值也不大</p>\n<p>该样本拓线出证书特征为<code>Quasar Server CA</code></p>\n<h2 id=\"QakBot\"><a href=\"#QakBot\" class=\"headerlink\" title=\"QakBot\"></a>QakBot</h2><p>QBot是一个模块化的信息窃取器，也被称为Qakbot或Pinkslipbot。它从受感染的系统中窃取金融数据，以及使用C2服务器进行有效载荷定位和下载的加载器。</p>\n<p>使用文章<a href=\"https://news.sophos.com/en-us/2023/04/20/new-qakbot-c2-servers-detected-with-sophos-ndr/\">使用 Sophos NDR 检测到新的 QakBot C2 服务器 – Sophos News</a>中提到的C2进行分析</p>\n<h3 id=\"173-18-122-24\"><a href=\"#173-18-122-24\" class=\"headerlink\" title=\"173.18.122.24\"></a>173.18.122.24</h3><p><code>ip:\"173.18.122.24\"</code></p>\n<p>搜索结果只开放了443端口，查看一下端口的特征值，这里注意返回的banner信息和网页hash</p>\n<p><img src=\"https://cdn.staticaly.com/gh/L2ksy0d/image-host@master/20220211/image-20230523194851137.4v27dwx1bfc0.png\"></p>\n<p>通过网页hash进行拓展</p>\n<p><code>http.html_hash:501510358</code></p>\n<p><img src=\"https://cdn.staticaly.com/gh/L2ksy0d/image-host@master/20220211/image-20230523194941070.3m3r31coybq0.png\"></p>\n<p>结果显示近9W条，这显然证明只通过网页hash颗粒度不够，由于shadon看不了这个IP的JARM指纹，我们通过fofa查看</p>\n<p><img src=\"https://cdn.staticaly.com/gh/L2ksy0d/image-host@master/20220211/image-20230523195149456.5wm46a5sdao0.png\"></p>\n<p>尝试通过JARM指纹和网页hash一起查询</p>\n<p><code>http.html_hash:501510358  ssl.jarm:\"21d14d00021d21d21c42d43d0000007abc6200da92c2a1b69c0a56366cbe21\"</code></p>\n<p><img src=\"https://cdn.staticaly.com/gh/L2ksy0d/image-host@master/20220211/image-20230523195323997.4qpg7tvrjbe0.png\"></p>\n<p>共找到了88个结果，这个结果就在可接受的用来优化的范围内了，但还是要注意下其他的特征</p>\n<p>例如我们的原IP banner信息：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">HTTP/1.1 200 OK\nContent-Length: 4833\nServer: nginx/1.9.12<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>可以看到首页的数据基本都相符，那么我们就暂时以这88个数据为基础再提取其他的特征，通过聚合查看其他特征</p>\n<p>其中对于<code>http.headers_hash</code>只存在一个值<code>-1219739159</code></p>\n<p><img src=\"https://cdn.staticaly.com/gh/L2ksy0d/image-host@master/20220211/image-20230523195637241.u47c1sqn92o.png\"></p>\n<p>此时只有一个特征的值就可以拿来进行下一步操作，我们通过<code>html_hash</code>和<code>headers_hash</code>反查JARM</p>\n<p><code>http.html_hash:501510358 http.headers_hash:-1219739159</code></p>\n<p><img src=\"https://cdn.staticaly.com/gh/L2ksy0d/image-host@master/20220211/image-20230523195912289.4dk4toqq5ne0.png\"></p>\n<p>除了我们开头提取的<code>21d</code>这个JARM，还或取到了一个有一定数量的<code>04d</code></p>\n<p>将JARM筛选也加上</p>\n<p><code>http.html_hash:501510358 http.headers_hash:-1219739159 ssl.jarm:\"04d02d00004d04d04c04d02d04d04d9674c6b4e623ae36cc2d998e99e2262e\"</code></p>\n<p><img src=\"https://cdn.staticaly.com/gh/L2ksy0d/image-host@master/20220211/image-20230523200018114.5jazn6rgc6g0.png\"></p>\n<p><img src=\"https://cdn.staticaly.com/gh/L2ksy0d/image-host@master/20220211/image-20230523200246768.3ua5qzq5two0.png\"></p>\n<p>惊喜来了，这些IP的banner全部符合之前IP的情况，端口也都是统一的443，所以我们可以认为这些IP也是疑似QakBot</p>\n<p>那么这时候我们就可以把JARM的条件去掉，只用``http.html_hash:501510358 http.headers_hash:-1219739159`</p>\n<p><img src=\"https://cdn.staticaly.com/gh/L2ksy0d/image-host@master/20220211/image-20230523200347641.6umf0xlgpe40.png\"></p>\n<p>可以看到从1个IP拓线出了110个疑似QakBot的IP</p>\n<p>剩下的那个IP就留给师傅们去尝试</p>\n<h2 id=\"结语\"><a href=\"#结语\" class=\"headerlink\" title=\"结语\"></a>结语</h2><p>笔者最近从事Hunting和情报相关工作，做简单的抛砖引玉，希望各位师傅不吝赐教！期待与各位师傅一起进步！</p>\n","feature":true,"text":"从IP和样本进行拓线Hunting前言在情报生产中当你拿到一批样本，应该思考如何通过样本里的C2或者特征去拓线找到更多的恶意样本或者C2链接，本文将给出从一个样本出发进行拓线分析的例子，大佬轻喷。 Q...","link":"","photos":[],"count_time":{"symbolsCount":"3k","symbolsTime":"3 mins."},"categories":[{"name":"Hunting","slug":"Hunting","count":2,"path":"api/categories/Hunting.json"}],"tags":[{"name":"Hunting","slug":"Hunting","count":2,"path":"api/tags/Hunting.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E4%BB%8EIP%E5%92%8C%E6%A0%B7%E6%9C%AC%E8%BF%9B%E8%A1%8C%E6%8B%93%E7%BA%BFHunting\"><span class=\"toc-text\">从IP和样本进行拓线Hunting</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%89%8D%E8%A8%80\"><span class=\"toc-text\">前言</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#QuasarRAT\"><span class=\"toc-text\">QuasarRAT</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%A0%B7%E6%9C%AC%E8%8E%B7%E5%8F%96\"><span class=\"toc-text\">样本获取</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90\"><span class=\"toc-text\">样本分析</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E5%BE%AE%E6%AD%A5%E4%BA%91%E6%B2%99%E7%AE%B1\"><span class=\"toc-text\">微步云沙箱</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#VirusTotal\"><span class=\"toc-text\">VirusTotal</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#59-26-93-6\"><span class=\"toc-text\">59.26.93.6</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#13-107-4-50\"><span class=\"toc-text\">13.107.4.50</span></a></li></ol></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#IP%E5%88%86%E6%9E%90\"><span class=\"toc-text\">IP分析</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E7%89%B9%E5%BE%81%E6%8B%93%E7%BA%BF\"><span class=\"toc-text\">特征拓线</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#QakBot\"><span class=\"toc-text\">QakBot</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#173-18-122-24\"><span class=\"toc-text\">173.18.122.24</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E7%BB%93%E8%AF%AD\"><span class=\"toc-text\">结语</span></a></li></ol></li></ol>","author":{"name":"RainSec","slug":"blog-author","avatar":"https://cdn.staticaly.com/gh/L2ksy0d/image-host@master/20220714/logo.jpg","link":"/","description":"艺术家思维去思考问题，工匠创造精神去开发","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{},"next_post":{"title":"西湖论剑 - Upnp","uid":"cabdfd8510238300fc39d39eb471ed7e","slug":"2022西湖论剑Upnp","date":"2023-04-18T10:38:45.000Z","updated":"2023-04-19T12:02:53.651Z","comments":true,"path":"api/articles/2022西湖论剑Upnp.json","keywords":null,"cover":"https://cdn.staticaly.com/gh/L2ksy0d/image-host@master/20230418/LOGO_large-26.5pizuezdjzk0.jpg","text":"西湖论剑WriteUP - Upnp前言这次应该是以一个NETGEAR R7000路由器的nDay为基础出的题，当时还在想是不是要挖上面的UPnP的0Day，没有意识到需要进行信息收集找相关漏洞分析。...","link":"","photos":[],"count_time":{"symbolsCount":"16k","symbolsTime":"15 mins."},"categories":[{"name":"CTF","slug":"CTF","count":2,"path":"api/categories/CTF.json"}],"tags":[{"name":"CTF","slug":"CTF","count":2,"path":"api/tags/CTF.json"}],"author":{"name":"RainSec","slug":"blog-author","avatar":"https://cdn.staticaly.com/gh/L2ksy0d/image-host@master/20220714/logo.jpg","link":"/","description":"艺术家思维去思考问题，工匠创造精神去开发","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":true}}